# Dins Test Task  for BD Java Developer Intern
## О приложении
Консольное Java приложение, работающее с Apache Kafka и PostgreSQL с использованием Spring Boot. Приложение работает в двух режимах:
1. Читается содержимое таблицы базы данных, каждая строка записывается в виде отдельного сообщения в Kafka topic;
2. Содержимое Kafka topic считывается и записывается во вторую таблицу в базе данных.

Изначально для работы с базой данных планировалось использовать интерфейс JPARepository, 
однако при дальнейшем выполнении оказалось, что при таком подходе невозможно задать имя таблицы через конфигурационный файл, что является частью задания.
Поэтому было принято решение вручную создавать подключение и писать запросы.


## Настройка подключения

### Конфигурация
Для конфигурации приложения используется файл application.yml (dins/src/main/resources/application.yml).
В нем описана информация, которая нам нужна для подключения к Kafka и базе данных из приложения.

Для более простого запуска можно воспользоваться уже имеющимся файлом application.yml и запустить Kafka и PostgreSQL с помощью существующего docker-compose файла. При желании нужную конфигурацию можно изменить.

Для подключения к базе данных:
```yml
spring:
    datasource:
        url: { url }
        username: { username }
        password: { password }
```

Для задания названия таблиц для чтения и записи:
```yml
spring:
  datasource:
    user:
      table:
        read:
          name: {read table name}
        write:
          name: { write table name }
```

Для настройки Kafka:
```yml
kafka:
    consumer:
      bootstrap-servers: localhost:{port}
      group-id: group_id
    producer:
      bootstrap-servers: localhost:{port}
    topic:
      name: {topic name}
```
### База данных
В папке utils находятся файлы, с помощью которых можно создать необходимые таблицы в базе данных и заполнить ее данными.
Для генерирования записей использовался generate_inserts.js скрипт, который сохраняет сгенерированные записи в inserts.sql.

В файле db_init_script.sql находится скрипт для создания нужных таблиц и заполнения ее данными, которые сгенерировал скрипт на JS.

### Docker
При разработке приложения, Kafka и PostgreSQL запускались в Docker контейнерах. Для запуска использовался docker-compose.yml.

```
docker-compose up
```

## Работа приложения
### Запуск режимов
После запуска приложения в консоль будет выведена информация:
```text
Тестовое задание для Dins на вакансию Java Intern. Выполнила Зырянова Анастасия.
Пожалуйста, выберите режим запуска приложения. Для выбора введите цифру:
1 - Читает содержимое таблицы и пишет в Kafka topic;
2 - Получает все данные топика и пишет в таблицу
```
Для запуска приложения в нужном режиме нужно ввести в консоль цифру - 1 или 2. 
- При выборе несуществующего режима программа сообщит об этом и закончит свое выполнение.
- При выборе существующего режима программа исполнится и завершится, как только обработает все записи.

### Первый режим
В первом режиме приложение считывает все данные из таблицы, название которой было задано в конфигурации (spring.datasource.user.table.read). Ответ на запрос в базу данных возвращается в виде ResultSet.
Из него мы по очереди отправляем каждую строку в kafka topic.
При успешном завершении в логи выводится количество отправленных записей в kafka topic. Приложение завершает свою работу.

### Второй режим
Во втором режиме работы приложение запускает kafka consumer. 
Consumer получает запись из топика и записывает ее в таблицу, название которой опять же было задано в конфигурации (spring.datasource.user.table.write).
После того как consumer прочитал все сообщения из топика приложение завершает работу.
Для того, чтобы завершить работу косньюмера, используется EventListener. 
Если в течение IdleInterval consumer не получал новых сообщений, то будет создано особое событие, при котором EventListener завершит работу приложения.


Для настройки значения IdleInterval необходимо зайти в конфигурационный файл и изменить значение:
```yml
spring:
  kafka:
    consumer:
      idleInterval: { значение интервала в  миллисекундах}
```





